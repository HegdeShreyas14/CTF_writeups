import numpy as np
from math import tanh, cos, sinh, exp
from scipy.optimize import minimize

# ===============================
# Constants from C
# ===============================
TARGET = 0.7331337420
EPS = 1e-5

XOR_KEYS = [
    0x42, 0x13, 0x37, 0x99, 0x21,
    0x88, 0x45, 0x67, 0x12, 0x34,
    0x56, 0x78, 0x9A, 0xBC, 0xDE
]

W1 = np.array([
    [0.523, -0.891, 0.234, 0.667, -0.445, 0.789, -0.123, 0.456],
    [-0.334, 0.778, -0.556, 0.223, 0.889, -0.667, 0.445, -0.221],
    [0.667, -0.234, 0.891, -0.445, 0.123, 0.556, -0.789, 0.334],
    [-0.778, 0.445, -0.223, 0.889, -0.556, 0.234, 0.667, -0.891],
    [0.123, -0.667, 0.889, -0.334, 0.556, -0.778, 0.445, 0.223],
    [-0.891, 0.556, -0.445, 0.778, -0.223, 0.334, -0.667, 0.889],
    [0.445, -0.123, 0.667, -0.889, 0.334, -0.556, 0.778, -0.234],
    [-0.556, 0.889, -0.334, 0.445, -0.778, 0.667, -0.223, 0.123],
    [0.778, -0.445, 0.556, -0.667, 0.223, -0.889, 0.334, -0.445],
    [-0.223, 0.667, -0.778, 0.334, -0.445, 0.556, -0.889, 0.778],
    [0.889, -0.334, 0.445, -0.556, 0.667, -0.223, 0.123, -0.667],
    [-0.445, 0.223, -0.889, 0.778, -0.334, 0.445, -0.556, 0.889],
    [0.334, -0.778, 0.223, -0.445, 0.889, -0.667, 0.556, -0.123],
    [-0.667, 0.889, -0.445, 0.223, -0.556, 0.778, -0.334, 0.667],
    [0.556, -0.223, 0.778, -0.889, 0.445, -0.334, 0.889, -0.556]
])

B1 = np.array([0.1, -0.2, 0.3, -0.15, 0.25, -0.35, 0.18, -0.28])

W2 = np.array([
    [0.712, -0.534, 0.823, -0.445, 0.667, -0.389],
    [-0.623, 0.889, -0.456, 0.734, -0.567, 0.445],
    [0.534, -0.712, 0.389, -0.823, 0.456, -0.667],
    [-0.889, 0.456, -0.734, 0.567, -0.623, 0.823],
    [0.445, -0.667, 0.823, -0.389, 0.712, -0.534],
    [-0.734, 0.623, -0.567, 0.889, -0.456, 0.389],
    [0.667, -0.389, 0.534, -0.712, 0.623, -0.823],
    [-0.456, 0.823, -0.667, 0.445, -0.889, 0.734]
])

B2 = np.array([0.05, -0.12, 0.18, -0.08, 0.22, -0.16])

W3 = np.array([0.923, -0.812, 0.745, -0.634, 0.856, -0.723])
B3 = 0.42

# ===============================
# Activations
# ===============================
def xor_activate(x, key):
    v = int(x * 1_000_000)
    v ^= key
    return v / 1_000_000.0

def sigmoid(x):
    return 1.0 / (1.0 + exp(-x))

# ===============================
# Forward pass (exact)
# ===============================
def forward(x):
    h1 = np.zeros(8)

    for j in range(8):
        for i in range(15):
            if i % 4 == 0:
                a = xor_activate(x[i], XOR_KEYS[i])
            elif i % 4 == 1:
                a = tanh(x[i])
            elif i % 4 == 2:
                a = cos(x[i])
            else:
                a = sinh(x[i] / 10.0)
            h1[j] += a * W1[i][j]
        h1[j] = tanh(h1[j] + B1[j])

    h2 = np.tanh(h1 @ W2 + B2)
    out = sigmoid(h2 @ W3 + B3)
    return out

# ===============================
# Objective
# ===============================
def loss(x):
    return abs(forward(x) - TARGET)

# ===============================
# Solve
# ===============================
x0 = np.zeros(15)

res = minimize(
    loss,
    x0,
    method="Nelder-Mead",
    options={"maxiter": 300_000, "xatol": 1e-9, "fatol": 1e-9}
)

print("\nRecovered inputs:")
for v in res.x:
    print(v)

print("\nFinal probability:", forward(res.x))
